{% extends "base.html" %}

{% block content %}
<section class="panel">
  <div class="panel-header">
    <h2>
      Issue Register
      {% if last_meeting_run_end %}
        <span class="subtle">(as of {{ last_meeting_run_end }})</span>
      {% endif %}
    </h2>
  </div>

  {% include "partials/issue_filters.html" %}

  <form class="form inline" action="/analysis/meetings" method="post" onsubmit="document.getElementById('analysis-spinner').classList.remove('hidden');">
    <div class="form-row">
      <label>
        Analyze meetings (start)
        <input type="date" name="start" value="{{ default_analysis_start }}" />
      </label>
      <label>
        End
        <input type="date" name="end" value="{{ default_analysis_end }}" />
      </label>
      <label>
        Top-K Candidates
        <input type="number" name="top_k" min="5" max="200" value="50" />
      </label>
      <input type="hidden" name="return_to" value="/" />
      <button class="secondary" type="submit">Run Analysis</button>
      <span id="analysis-spinner" class="spinner hidden" aria-live="polite">Runningâ€¦</span>
    </div>
  </form>

  <form class="form" hx-post="/issues" hx-target="#issue-list" hx-swap="afterbegin">
    <div class="form-row">
      <label>
        Title
        <input type="text" name="title" placeholder="Describe the issue" required />
      </label>
      <label>
        Domain
        <select name="domain">
          <option value="General">General</option>
          {% for option in domain_options %}
            <option value="{{ option.name }}">{{ option.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        Owner
        <select name="owner">
          <option value="">Unassigned</option>
          {% for option in owner_options %}
            <option value="{{ option.name }}">{{ option.name }}</option>
          {% endfor %}
        </select>
      </label>
    </div>
    <button class="primary" type="submit">Add Issue</button>
  </form>

  <form class="form inline" action="/issues/merge" method="post">
    <div class="form-row">
      <label>
        Merge Into (Issue ID)
        <input type="number" name="target_id" min="1" required />
      </label>
      <label>
        Source IDs (comma-separated)
        <input type="text" name="source_ids" placeholder="e.g. 4,5,6" required />
      </label>
      <input type="hidden" name="return_to" value="/" />
      <button class="secondary" type="submit">Merge Issues</button>
    </div>
  </form>

  <div id="issue-list" hx-get="/issues" hx-trigger="load, issue-created from:body">
    {% include "partials/issues_list.html" %}
  </div>
</section>
{% endblock %}
